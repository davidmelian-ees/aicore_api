<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentaciÃ³n TÃ©cnica - Sistema de ValidaciÃ³n de Pliegos - David MeliÃ¡n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; background-color: #f8f9fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 40px 0; text-align: center; margin-bottom: 30px; }
        h1 { font-size: 2.8em; margin-bottom: 10px; }
        .subtitle { font-size: 1.2em; opacity: 0.9; }
        nav { background: #343a40; padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        nav ul { list-style: none; display: flex; justify-content: center; flex-wrap: wrap; }
        nav li { margin: 0 15px; }
        nav a { color: white; text-decoration: none; padding: 8px 15px; border-radius: 5px; transition: background 0.3s; }
        nav a:hover { background: #495057; }
        .section { background: white; margin: 30px 0; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #1e3c72; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #2a5298; }
        h3 { color: #2a5298; margin-top: 25px; margin-bottom: 15px; }
        h4 { color: #495057; margin-top: 20px; margin-bottom: 10px; }
        .code-block { background: #282c34; color: #abb2bf; padding: 20px; border-radius: 8px; overflow-x: auto; margin: 15px 0; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.5; }
        .code-inline { background: #e9ecef; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; color: #d63384; font-size: 0.9em; }
        .file-path { background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 15px; margin: 15px 0; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9em; }
        .function-signature { background: #d1ecf1; border-left: 4px solid #0c5460; padding: 15px; margin: 15px 0; border-radius: 5px; font-family: 'Courier New', monospace; }
        .flow-diagram { background: #f8f9fa; border: 2px solid #dee2e6; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .warning-box { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .info-box { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .success-box { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #2a5298; color: white; font-weight: 600; }
        tr:hover { background: #f8f9fa; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600; margin: 0 5px; }
        .badge-new { background: #28a745; color: white; }
        .badge-critical { background: #dc3545; color: white; }
        footer { text-align: center; padding: 30px 0; color: #6c757d; margin-top: 50px; }
        .toc { background: #e9ecef; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .toc ul { list-style: none; padding-left: 20px; }
        .toc li { margin: 8px 0; }
        .toc a { color: #1e3c72; text-decoration: none; }
        .toc a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ“š DocumentaciÃ³n TÃ©cnica</h1>
            <p class="subtitle">Sistema de ValidaciÃ³n de Pliegos SAP - ImplementaciÃ³n y CÃ³digo</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Ãšltima actualizaciÃ³n: 11 de Noviembre de 2025</p>
        </div>
    </header>

    <nav>
        <ul>
            <li><a href="#arquitectura">Arquitectura</a></li>
            <li><a href="#validacion-numerica">ValidaciÃ³n NumÃ©rica</a></li>
            <li><a href="#validacion-tablas">ValidaciÃ³n Tablas</a></li>
            <li><a href="#patrones-aprendidos">Patrones Aprendidos</a></li>
            <li><a href="#funciones-clave">Funciones Clave</a></li>
            <li><a href="#prompts">Sistema de Prompts</a></li>
        </ul>
    </nav>

    <div class="container">
        
        <!-- TABLA DE CONTENIDOS -->
        <div class="section">
            <h2>ğŸ“‘ Tabla de Contenidos</h2>
            <div class="toc">
                <ul>
                    <li><a href="#arquitectura">1. Arquitectura del Sistema</a></li>
                    <li><a href="#validacion-numerica">2. ValidaciÃ³n NumÃ©rica (Coherencia de Presupuestos)</a></li>
                    <li><a href="#validacion-tablas">3. ValidaciÃ³n de Tablas APLICA/NO APLICA</a></li>
                    <li><a href="#patrones-aprendidos">4. Sistema de Aprendizaje de Patrones</a></li>
                    <li><a href="#funciones-clave">5. Funciones Clave del CÃ³digo</a></li>
                    <li><a href="#prompts">6. Sistema de Prompts</a></li>
                    <li><a href="#endpoints">7. Endpoints y APIs</a></li>
                </ul>
            </div>
        </div>

        <!-- ARQUITECTURA -->
        <div class="section" id="arquitectura">
            <h2>ğŸ—ï¸ 1. Arquitectura del Sistema</h2>
            
            <h3>Estructura de Archivos</h3>
            
            <div class="file-path">
ğŸ“ aicore_api/<br>
â”œâ”€â”€ ğŸ“ routes/<br>
â”‚   â””â”€â”€ pdfCorrection.js          â† Endpoints HTTP<br>
â”œâ”€â”€ ğŸ“ services/<br>
â”‚   â”œâ”€â”€ pdfCorrectionService.js   â† LÃ³gica principal de validaciÃ³n<br>
â”‚   â”œâ”€â”€ ragService.js             â† BÃºsqueda en contexto RAG<br>
â”‚   â””â”€â”€ sqliteVectorStore.js      â† Almacenamiento de vectores<br>
â”œâ”€â”€ ğŸ“ prompts_dev/<br>
â”‚   â”œâ”€â”€ ERRORES_COMUNES_PLIEGOS.txt<br>
â”‚   â”œâ”€â”€ PLIEGOS_VALIDATION_SYSTEM.txt<br>
â”‚   â”œâ”€â”€ NOMENCLATURA_PLIEGOS.txt<br>
â”‚   â””â”€â”€ PLIEGOS_ERRORES_EJEMPLOS.txt<br>
â””â”€â”€ ğŸ“ public/<br>
    â””â”€â”€ documentacion_tecnica_codigo.html  â† Este archivo
            </div>

            <h3>Componentes Principales</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Componente</th>
                        <th>Archivo</th>
                        <th>Responsabilidad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Endpoints HTTP</strong></td>
                        <td><code>routes/pdfCorrection.js</code></td>
                        <td>RecepciÃ³n de PDFs, orquestaciÃ³n de validaciÃ³n</td>
                    </tr>
                    <tr>
                        <td><strong>Motor de ValidaciÃ³n</strong></td>
                        <td><code>services/pdfCorrectionService.js</code></td>
                        <td>ConstrucciÃ³n de prompts, llamadas a IA, anÃ¡lisis de patrones</td>
                    </tr>
                    <tr>
                        <td><strong>Sistema RAG</strong></td>
                        <td><code>services/ragService.js</code></td>
                        <td>BÃºsqueda semÃ¡ntica en contextos</td>
                    </tr>
                    <tr>
                        <td><strong>Base de Prompts</strong></td>
                        <td><code>prompts_dev/*.txt</code></td>
                        <td>Reglas de validaciÃ³n, ejemplos, patrones</td>
                    </tr>
                </tbody>
            </table>

            <h3>Flujo de Datos</h3>
            
            <div class="flow-diagram">
                <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario    â”‚
â”‚  Sube PDF   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/pdf-correction/generate-list-from-context        â”‚
â”‚  (routes/pdfCorrection.js lÃ­neas 61-120)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  generatePDFWithCorrectionsFromContext()                    â”‚
â”‚  (services/pdfCorrectionService.js lÃ­neas 295-420)          â”‚
â”‚                                                              â”‚
â”‚  1. Cargar prompts de validaciÃ³n                            â”‚
â”‚  2. ğŸ†• Analizar patrones del contexto                        â”‚
â”‚  3. ğŸ†• Extraer patrones con IA                               â”‚
â”‚  4. Buscar documentos relevantes en RAG                      â”‚
â”‚  5. Construir prompt con patrones aprendidos                 â”‚
â”‚  6. Enviar a SAP AI Core                                     â”‚
â”‚  7. Generar PDF con informe                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PDF con    â”‚
â”‚  Informe de â”‚
â”‚  ValidaciÃ³n â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </pre>
            </div>
        </div>

        <!-- VALIDACIÃ“N NUMÃ‰RICA -->
        <div class="section" id="validacion-numerica">
            <h2>ğŸ§® 2. ValidaciÃ³n NumÃ©rica</h2>
            
            <div class="success-box">
                <strong>ğŸ†• Nueva Funcionalidad:</strong> La IA realiza cÃ¡lculos matemÃ¡ticos explÃ­citos para validar coherencia entre presupuesto total y suma de lotes.
            </div>

            <h3>UbicaciÃ³n en el CÃ³digo</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Archivo</th>
                        <th>LÃ­neas</th>
                        <th>DescripciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>prompts_dev/ERRORES_COMUNES_PLIEGOS.txt</code></td>
                        <td>200-290</td>
                        <td>DefiniciÃ³n completa del error #10</td>
                    </tr>
                    <tr>
                        <td><code>services/pdfCorrectionService.js</code></td>
                        <td>87-96</td>
                        <td>Instrucciones en prompt principal</td>
                    </tr>
                    <tr>
                        <td><code>services/pdfCorrectionService.js</code></td>
                        <td>142-155</td>
                        <td>Ejemplo explÃ­cito de validaciÃ³n</td>
                    </tr>
                </tbody>
            </table>

            <h3>Proceso de ValidaciÃ³n</h3>
            
            <div class="flow-diagram">
                <pre>
PASO 1: Buscar "PRESSUPOST DE LICITACIÃ“"
         â†“
PASO 2: Extraer importe total (IVA inclÃ²s)
         â†“
PASO 3: Buscar tabla de lotes
         â†“
PASO 4: Extraer TODOS los importes de lotes
         â†“
PASO 5: SUMAR manualmente: Lot1 + Lot2 + ...
         â†“
PASO 6: COMPARAR: suma vs presupuesto declarado
         â†“
PASO 7: CALCULAR diferencia absoluta
         â†“
PASO 8: REPORTAR si diferencia > 0.50â‚¬
                </pre>
            </div>

            <h3>CÃ³digo del Prompt</h3>
            
            <div class="function-signature">
<strong>Archivo:</strong> services/pdfCorrectionService.js<br>
<strong>LÃ­neas:</strong> 87-96<br><br>
3. REALIZA CÃLCULOS MATEMÃTICOS EXPLÃCITOS:<br>
   - Si encuentras "PRESSUPOST DE LICITACIÃ“"<br>
   - EXTRAE el importe total declarado<br>
   - BUSCA la tabla de lotes<br>
   - EXTRAE todos los importes de cada lote<br>
   - SUMA manualmente: Lot1 + Lot2 + Lot3 + ...<br>
   - COMPARA: Â¿TOTAL calculado == TOTAL declarado?<br>
   - Si NO coinciden: REPORTA como ERROR CRÃTICO
            </div>

            <h3>Niveles de Severidad</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Diferencia</th>
                        <th>Severidad</th>
                        <th>AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>&lt; 1â‚¬</td>
                        <td><span class="badge" style="background: #28a745; color: white;">âœ… OK</span></td>
                        <td>Tolerancia por redondeo</td>
                    </tr>
                    <tr>
                        <td>1â‚¬ - 100â‚¬</td>
                        <td><span class="badge" style="background: #ffc107; color: black;">ğŸŸ¡ WARNING</span></td>
                        <td>Posible error de redondeo</td>
                    </tr>
                    <tr>
                        <td>&gt; 100â‚¬</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                        <td>Error de cÃ¡lculo grave</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- VALIDACIÃ“N TABLAS -->
        <div class="section" id="validacion-tablas">
            <h2>ğŸ“Š 3. ValidaciÃ³n de Tablas APLICA/NO APLICA</h2>
            
            <div class="success-box">
                <strong>ğŸ†• Nueva Funcionalidad:</strong> La IA cuenta valores columna por columna para detectar filas incompletas.
            </div>

            <h3>UbicaciÃ³n en el CÃ³digo</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Archivo</th>
                        <th>LÃ­neas</th>
                        <th>DescripciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>prompts_dev/ERRORES_COMUNES_PLIEGOS.txt</code></td>
                        <td>144-237</td>
                        <td>DefiniciÃ³n completa del error #8</td>
                    </tr>
                    <tr>
                        <td><code>services/pdfCorrectionService.js</code></td>
                        <td>98-104</td>
                        <td>Instrucciones en prompt principal</td>
                    </tr>
                    <tr>
                        <td><code>services/pdfCorrectionService.js</code></td>
                        <td>157-174</td>
                        <td>Ejemplo explÃ­cito de validaciÃ³n</td>
                    </tr>
                </tbody>
            </table>

            <h3>Proceso de ValidaciÃ³n</h3>
            
            <div class="flow-diagram">
                <pre>
PASO 1: Identificar tabla con encabezados "APLICA" y "NO APLICA"
         â†“
PASO 2: Contar nÃºmero de columnas en encabezado (debe ser 2)
         â†“
PASO 3: Para CADA fila:
         - Contar valores "APLICA"
         - Contar valores "NO APLICA"
         - Contar campos vacÃ­os
         â†“
PASO 4: Validar: Â¿cada fila tiene 2 valores?
         â†“
PASO 5: REPORTAR filas con solo 1 valor
                </pre>
            </div>

            <h3>CÃ³digo del Prompt</h3>
            
            <div class="function-signature">
<strong>Archivo:</strong> services/pdfCorrectionService.js<br>
<strong>LÃ­neas:</strong> 98-104<br><br>
4. VALIDA TABLAS APLICA/NO APLICA COLUMNA POR COLUMNA:<br>
   - Si encuentras tabla con columnas "APLICA" y "NO APLICA"<br>
   - CUENTA el nÃºmero de columnas en el encabezado (debe ser 2)<br>
   - Para CADA fila: CUENTA cuÃ¡ntos valores tiene<br>
   - Si una fila tiene solo 1 valor: ERROR CRÃTICO<br>
   - IDENTIFICA exactamente quÃ© filas tienen campos vacÃ­os<br>
   - REPORTA con nÃºmero de fila y nombre del criterio
            </div>
        </div>

        <!-- PATRONES APRENDIDOS -->
        <div class="section" id="patrones-aprendidos">
            <h2>ğŸ§  4. Sistema de Aprendizaje de Patrones</h2>
            
            <div class="success-box">
                <strong>ğŸ†• Nueva Funcionalidad:</strong> La IA aprende automÃ¡ticamente de todos los pliegos en el contexto RAG y detecta anomalÃ­as.
            </div>

            <h3>UbicaciÃ³n en el CÃ³digo</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>FunciÃ³n</th>
                        <th>Archivo</th>
                        <th>LÃ­neas</th>
                        <th>DescripciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>analyzeContextPatterns()</code></td>
                        <td>services/pdfCorrectionService.js</td>
                        <td>195-268</td>
                        <td>Analiza 30 documentos y construye prompt de anÃ¡lisis</td>
                    </tr>
                    <tr>
                        <td><code>ExtracciÃ³n con IA</code></td>
                        <td>services/pdfCorrectionService.js</td>
                        <td>308-325</td>
                        <td>Llama a SAP AI Core para extraer patrones</td>
                    </tr>
                    <tr>
                        <td><code>buildValidationPrompt()</code></td>
                        <td>services/pdfCorrectionService.js</td>
                        <td>81-97</td>
                        <td>Integra patrones aprendidos en prompt de validaciÃ³n</td>
                    </tr>
                </tbody>
            </table>

            <h3>Flujo TÃ©cnico Completo</h3>
            
            <div class="flow-diagram">
                <pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. analyzeContextPatterns(contextId)                    â”‚
â”‚     LÃ­neas 195-268                                       â”‚
â”‚                                                           â”‚
â”‚     â€¢ Busca 30 documentos del contexto                   â”‚
â”‚     â€¢ Construye prompt de anÃ¡lisis                       â”‚
â”‚     â€¢ Retorna: { documentsAnalyzed, analysisPrompt }     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ExtracciÃ³n de Patrones con IA                        â”‚
â”‚     LÃ­neas 308-325                                       â”‚
â”‚                                                           â”‚
â”‚     const client = getAiCoreClient('gpt-4o');            â”‚
â”‚     const response = await client.run({                  â”‚
â”‚       messages: [{ role: 'user',                         â”‚
â”‚                    content: analysisPrompt }]            â”‚
â”‚     });                                                  â”‚
â”‚                                                           â”‚
â”‚     IA extrae:                                           â”‚
â”‚     â€¢ Secciones comunes (70%+ frecuencia)                â”‚
â”‚     â€¢ Puntos de numeraciÃ³n recurrentes                   â”‚
â”‚     â€¢ Tablas tÃ­picas                                     â”‚
â”‚     â€¢ Campos variables estÃ¡ndar                          â”‚
â”‚     â€¢ Orden habitual de secciones                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. buildValidationPrompt(text, ragContext, patterns)    â”‚
â”‚     LÃ­neas 81-97                                         â”‚
â”‚                                                           â”‚
â”‚     Incluye en el prompt:                                â”‚
â”‚     ${learnedPatterns ? `                                â”‚
â”‚       PATRONES APRENDIDOS DEL CONTEXTO:                  â”‚
â”‚       ${learnedPatterns.patternsText}                    â”‚
â”‚                                                           â”‚
â”‚       VALIDACIÃ“N DE ANOMALÃAS:                           â”‚
â”‚       - Si secciÃ³n aparece en 8+ docs pero NO aquÃ­:      â”‚
â”‚         ğŸŸ¡ ADVERTENCIA                                   â”‚
â”‚     ` : ''}                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. IA Valida Documento Contra Patrones                  â”‚
â”‚                                                           â”‚
â”‚     Detecta anomalÃ­as automÃ¡ticamente                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                </pre>
            </div>

            <h3>CÃ³digo de analyzeContextPatterns()</h3>
            
            <div class="function-signature">
<strong>Archivo:</strong> services/pdfCorrectionService.js<br>
<strong>LÃ­neas:</strong> 195-268<br><br>
async function analyzeContextPatterns(contextId) {<br>
&nbsp;&nbsp;// Buscar 30 documentos del contexto<br>
&nbsp;&nbsp;const ragResults = await searchContext(<br>
&nbsp;&nbsp;&nbsp;&nbsp;`estructura secciones puntos numeraciÃ³n Ã­ndice`,<br>
&nbsp;&nbsp;&nbsp;&nbsp;{ contextId: contextId, topK: 30 }<br>
&nbsp;&nbsp;);<br>
<br>
&nbsp;&nbsp;// Construir prompt para anÃ¡lisis<br>
&nbsp;&nbsp;const patternAnalysisPrompt = `<br>
&nbsp;&nbsp;&nbsp;&nbsp;Analiza los siguientes ${ragResults.length} documentos<br>
&nbsp;&nbsp;&nbsp;&nbsp;y extrae PATRONES COMUNES:<br>
&nbsp;&nbsp;&nbsp;&nbsp;1. Secciones que aparecen en MAYORÃA de documentos<br>
&nbsp;&nbsp;&nbsp;&nbsp;2. Puntos de numeraciÃ³n recurrentes<br>
&nbsp;&nbsp;&nbsp;&nbsp;3. Tablas comunes<br>
&nbsp;&nbsp;&nbsp;&nbsp;...<br>
&nbsp;&nbsp;`;<br>
<br>
&nbsp;&nbsp;return { documentsAnalyzed, analysisPrompt };<br>
}
            </div>

            <h3>Patrones que Detecta</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Tipo de PatrÃ³n</th>
                        <th>Ejemplo</th>
                        <th>AcciÃ³n si Falta</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Secciones Comunes</strong></td>
                        <td>"18. GARANTÃAS" aparece en 9/10 documentos</td>
                        <td>ğŸŸ¡ ADVERTENCIA: SecciÃ³n no encontrada</td>
                    </tr>
                    <tr>
                        <td><strong>Puntos de NumeraciÃ³n</strong></td>
                        <td>"25. MODIFICACIÃ“N" aparece en 8/10 documentos</td>
                        <td>ğŸŸ¡ ADVERTENCIA: Punto ausente</td>
                    </tr>
                    <tr>
                        <td><strong>Tablas Comunes</strong></td>
                        <td>"Criterios de ValoraciÃ³n" en 10/10 documentos</td>
                        <td>ğŸŸ¡ ADVERTENCIA: Tabla no detectada</td>
                    </tr>
                    <tr>
                        <td><strong>Orden de Secciones</strong></td>
                        <td>Objeto â†’ Presupuesto â†’ Plazo â†’ GarantÃ­as</td>
                        <td>ğŸŸ¡ ADVERTENCIA: Orden diferente</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- FUNCIONES CLAVE -->
        <div class="section" id="funciones-clave">
            <h2>âš™ï¸ 5. Funciones Clave del CÃ³digo</h2>
            
            <h3>Ãndice de Funciones</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>FunciÃ³n</th>
                        <th>Archivo</th>
                        <th>LÃ­neas</th>
                        <th>PropÃ³sito</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>loadValidationPrompts()</code></td>
                        <td>pdfCorrectionService.js</td>
                        <td>18-46</td>
                        <td>Carga archivos .txt de prompts_dev/</td>
                    </tr>
                    <tr>
                        <td><code>buildValidationPrompt()</code></td>
                        <td>pdfCorrectionService.js</td>
                        <td>49-207</td>
                        <td>Construye prompt completo con patrones</td>
                    </tr>
                    <tr>
                        <td><code>analyzeContextPatterns()</code></td>
                        <td>pdfCorrectionService.js</td>
                        <td>195-268</td>
                        <td>Analiza documentos y extrae patrones</td>
                    </tr>
                    <tr>
                        <td><code>generatePDFWithCorrectionsFromContext()</code></td>
                        <td>pdfCorrectionService.js</td>
                        <td>295-420</td>
                        <td>FunciÃ³n principal de validaciÃ³n con contexto</td>
                    </tr>
                    <tr>
                        <td><code>generatePDFWithCorrectionsList()</code></td>
                        <td>pdfCorrectionService.js</td>
                        <td>430-580</td>
                        <td>ValidaciÃ³n simple sin contexto RAG</td>
                    </tr>
                    <tr>
                        <td><code>searchContext()</code></td>
                        <td>ragService.js</td>
                        <td>Variable</td>
                        <td>BÃºsqueda semÃ¡ntica en contexto RAG</td>
                    </tr>
                </tbody>
            </table>

            <h3>Detalle: generatePDFWithCorrectionsFromContext()</h3>
            
            <div class="info-box">
                <strong>ğŸ“ UbicaciÃ³n:</strong> services/pdfCorrectionService.js, lÃ­neas 295-420<br>
                <strong>ğŸ¯ PropÃ³sito:</strong> FunciÃ³n principal que orquesta todo el proceso de validaciÃ³n con contexto RAG y patrones aprendidos
            </div>

            <div class="code-block">// LÃ­neas 295-420
export async function generatePDFWithCorrectionsFromContext(prompt, contextId) {
  // 1. Cargar prompts de validaciÃ³n
  const prompts = await loadValidationPrompts();

  // 2. ğŸ†• Analizar patrones del contexto
  const patternsAnalysis = await analyzeContextPatterns(contextId);
  
  // 3. ğŸ†• Extraer patrones con IA
  let learnedPatterns = null;
  if (patternsAnalysis) {
    const client = getAiCoreClient('gpt-4o');
    const patternResponse = await client.run({
      messages: [{ role: 'user', content: patternsAnalysis.analysisPrompt }]
    });
    learnedPatterns = {
      documentsAnalyzed: patternsAnalysis.documentsAnalyzed,
      patternsText: patternResponse.getContent()
    };
  }

  // 4. Buscar documentos relevantes en RAG
  const ragResults = await searchContext(
    `errores pliegos validaciÃ³n tags SAP ${prompt}`,
    { contextId: contextId, topK: 15 }
  );

  // 5. Construir prompt con patrones aprendidos
  const contextAnalysisPrompt = await buildValidationPrompt(
    `${prompt}\n\n${textForAnalysis}`,
    textForAnalysis,
    learnedPatterns  // ğŸ†• Incluye patrones
  );

  // 6. Enviar a SAP AI Core
  const client = getAiCoreClient('gpt-4o');
  const response = await client.run({
    messages: [{ role: 'user', content: contextAnalysisPrompt }]
  });

  // 7. Generar PDF con informe
  return correctionsReport;
}</div>

            <h3>Detalle: buildValidationPrompt()</h3>
            
            <div class="info-box">
                <strong>ğŸ“ UbicaciÃ³n:</strong> services/pdfCorrectionService.js, lÃ­neas 49-207<br>
                <strong>ğŸ¯ PropÃ³sito:</strong> Construye el prompt completo integrando prompts base + contexto RAG + patrones aprendidos
            </div>

            <div class="code-block">// LÃ­neas 49-207
async function buildValidationPrompt(textForAnalysis, ragContext, learnedPatterns) {
  const prompts = await loadValidationPrompts();
  
  return `SISTEMA DE VALIDACIÃ“N DE PLIEGOS SAP
================================================================================

ERRORES COMUNES A DETECTAR:
${prompts.erroresComunes}

${ragContext ? `CONTEXTO RAG ADICIONAL:
${ragContext}
` : ''}

${learnedPatterns ? `
================================================================================
PATRONES APRENDIDOS DEL CONTEXTO:
================================================================================

âš ï¸ INSTRUCCIÃ“N CRÃTICA: Los siguientes patrones fueron extraÃ­dos de 
${learnedPatterns.documentsAnalyzed} pliegos reales del contexto.
DEBES validar que el pliego actual siga estos patrones comunes.

${learnedPatterns.patternsText}

VALIDACIÃ“N DE ANOMALÃAS:
- Si una secciÃ³n aparece en 8+ documentos pero NO en este: ğŸŸ¡ ADVERTENCIA
- Si un punto aparece en 8+ documentos pero NO en este: ğŸŸ¡ ADVERTENCIA
` : ''}

================================================================================
INSTRUCCIONES DE VALIDACIÃ“N:
================================================================================

1. ANALIZA el texto MINUCIOSAMENTE
2. REALIZA CÃLCULOS MATEMÃTICOS EXPLÃCITOS
3. VALIDA TABLAS COLUMNA POR COLUMNA
4. DETECTA ANOMALÃAS BASÃNDOTE EN PATRONES APRENDIDOS

TEXTO DEL PLIEGO A VALIDAR:
${textForAnalysis}
`;</div>
        </div>

        <!-- SISTEMA DE PROMPTS -->
        <div class="section" id="prompts">
            <h2>ğŸ“ 6. Sistema de Prompts</h2>
            
            <h3>Archivos de Prompts</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Archivo</th>
                        <th>UbicaciÃ³n</th>
                        <th>Contenido</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>ERRORES_COMUNES_PLIEGOS.txt</code></td>
                        <td>prompts_dev/</td>
                        <td>10 tipos de errores con ejemplos y validaciones</td>
                    </tr>
                    <tr>
                        <td><code>PLIEGOS_VALIDATION_SYSTEM.txt</code></td>
                        <td>prompts_dev/</td>
                        <td>Sistema de validaciÃ³n estructural</td>
                    </tr>
                    <tr>
                        <td><code>NOMENCLATURA_PLIEGOS.txt</code></td>
                        <td>prompts_dev/</td>
                        <td>Patrones de nomenclatura esperada</td>
                    </tr>
                    <tr>
                        <td><code>PLIEGOS_ERRORES_EJEMPLOS.txt</code></td>
                        <td>prompts_dev/</td>
                        <td>Ejemplos especÃ­ficos de errores y patrones SAP</td>
                    </tr>
                </tbody>
            </table>

            <h3>Errores Definidos en ERRORES_COMUNES_PLIEGOS.txt</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Error</th>
                        <th>LÃ­neas</th>
                        <th>Severidad</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td>Tags SAP sin rellenar</td>
                        <td>10-30</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Campos SÃ/NO duplicados</td>
                        <td>32-55</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Formato de fechas incorrecto</td>
                        <td>57-75</td>
                        <td><span class="badge" style="background: #ffc107; color: black;">ğŸŸ¡ WARNING</span></td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Formato de importes incorrecto</td>
                        <td>77-95</td>
                        <td><span class="badge" style="background: #ffc107; color: black;">ğŸŸ¡ WARNING</span></td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>Palabras en castellano</td>
                        <td>97-115</td>
                        <td><span class="badge" style="background: #ffc107; color: black;">ğŸŸ¡ WARNING</span></td>
                    </tr>
                    <tr>
                        <td>6</td>
                        <td>Cantidad de lotes incorrecta</td>
                        <td>117-135</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                    </tr>
                    <tr>
                        <td>7</td>
                        <td>Saltos en numeraciÃ³n</td>
                        <td>137-143</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                    </tr>
                    <tr>
                        <td>8</td>
                        <td>Tablas APLICA/NO APLICA incompletas <span class="badge badge-new">NUEVO</span></td>
                        <td>144-237</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                    </tr>
                    <tr>
                        <td>9</td>
                        <td>Secciones obligatorias faltantes</td>
                        <td>239-260</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                    </tr>
                    <tr>
                        <td>10</td>
                        <td>Incoherencia numÃ©rica presupuestos <span class="badge badge-new">NUEVO</span></td>
                        <td>200-290</td>
                        <td><span class="badge badge-critical">ğŸ”´ CRÃTICO</span></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ENDPOINTS -->
        <div class="section" id="endpoints">
            <h2>ğŸŒ 7. Endpoints y APIs</h2>
            
            <h3>Endpoints Disponibles</h3>
            
            <table>
                <thead>
                    <tr>
                        <th>Endpoint</th>
                        <th>MÃ©todo</th>
                        <th>DescripciÃ³n</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>/api/pdf-correction/generate-list</code></td>
                        <td>POST</td>
                        <td>ValidaciÃ³n simple sin contexto RAG</td>
                    </tr>
                    <tr>
                        <td><code>/api/pdf-correction/generate-list-from-context</code></td>
                        <td>POST</td>
                        <td>ValidaciÃ³n con contexto RAG + patrones aprendidos <span class="badge badge-new">NUEVO</span></td>
                    </tr>
                </tbody>
            </table>

            <h3>Ejemplo de Uso</h3>
            
            <div class="code-block">// ValidaciÃ³n con contexto RAG y patrones aprendidos
POST /api/pdf-correction/generate-list-from-context

Content-Type: multipart/form-data

Body:
{
  "file": [PDF del pliego],
  "prompt": "Validar pliego de carreteras",
  "contextId": "dc298384-bea0-49f3-9980-73436ebfbff0"
}

Respuesta:
{
  "success": true,
  "pdfPath": "/uploads/validacion_pliego_20251111.pdf",
  "corrections": "ğŸ”´ ERRORES CRÃTICOS:\n- Incoherencia numÃ©rica...\n\nğŸŸ¡ ADVERTENCIAS:\n- Punto 18 no encontrado (aparece en 9/10 documentos)..."
}</div>
        </div>

<!-- FIN CONTENIDO -->

    </div>

    <footer>
        <p>&copy; 2025 David MeliÃ¡n - Sistema de ValidaciÃ³n de Pliegos SAP</p>
        <p style="margin-top: 10px; font-size: 0.9em;">DocumentaciÃ³n TÃ©cnica Generada AutomÃ¡ticamente</p>
    </footer>
</body>
</html>