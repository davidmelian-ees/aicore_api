================================================================================
                    GESTI√ìN DE CONTEXTOS RAG PARA PLIEGOS
                Sistema de Organizaci√≥n y Consulta Inteligente
================================================================================

OBJETIVO:
Organizar eficientemente los documentos de pliegos en contextos RAG espec√≠ficos
para maximizar la precisi√≥n de consultas y el aprendizaje del sistema.

================================================================================
                        ESTRUCTURA DE CONTEXTOS RAG
================================================================================

CONTEXTOS PRINCIPALES:

1. PLANTILLAS_BASE
   - Documentos: pliego_{tipo}_PLANTILLA
   - Prop√≥sito: Estructuras base limpias sin datos espec√≠ficos
   - Uso: Validaci√≥n estructural, referencia de apartados obligatorios

2. PLANTILLAS_TAGS
   - Documentos: pliego_{tipo}_PLANTILLA_TAGS  
   - Prop√≥sito: Mapeo de variables SAP y campos din√°micos
   - Uso: Identificaci√≥n de tags, validaci√≥n de completitud

3. PLIEGOS_GENERADOS_OBRA_CIVIL_OBERT
   - Documentos: pliego_obra_civil_obert_{modalidad}_generado
   - Prop√≥sito: Ejemplos reales de obra civil procedimiento abierto
   - Uso: Referencia de buenas pr√°cticas, respuesta a consultas espec√≠ficas

4. PLIEGOS_GENERADOS_OBRA_CIVIL_SIMPLIFICAT
   - Documentos: pliego_obra_civil_simplificat_{modalidad}_generado
   - Prop√≥sito: Ejemplos reales de obra civil procedimiento simplificado
   - Uso: Patrones de estructura simplificada

5. PLIEGOS_GENERADOS_OBRA_EDIFICACIO_OBERT
   - Documentos: pliego_obra_edificacio_obert_{modalidad}_generado
   - Prop√≥sito: Ejemplos reales de edificaci√≥n procedimiento abierto
   - Uso: Especificidades t√©cnicas de edificaci√≥n

6. PLIEGOS_GENERADOS_OBRA_EDIFICACIO_SIMPLIFICAT
   - Documentos: pliego_obra_edificacio_simplificat_{modalidad}_generado
   - Prop√≥sito: Ejemplos reales de edificaci√≥n procedimiento simplificado
   - Uso: Estructura m√≠nima viable para edificaci√≥n

7. ERRORES_COMUNES_PLIEGOS
   - Documentos: Casos con errores t√≠picos y documentaci√≥n de patrones
   - Prop√≥sito: Detecci√≥n autom√°tica de problemas frecuentes
   - Uso: Pre-validaci√≥n, identificaci√≥n de errores cr√≠ticos

8. CASOS_ESPECIALES_VALIDACION
   - Documentos: Pliegos con situaciones at√≠picas o complejas
   - Prop√≥sito: Manejo de casos edge y situaciones especiales
   - Uso: Resoluci√≥n de consultas complejas

================================================================================
                        ASIGNACI√ìN AUTOM√ÅTICA DE CONTEXTOS
================================================================================

ALGORITMO DE CLASIFICACI√ìN:

```javascript
function asignarContexto(nombreArchivo, contenido) {
  // 1. Detectar tipo base del nombre
  const tipoMatch = nombreArchivo.match(/pliego_(obra_civil_obert|obra_civil_simplificat|obra_edificacio_obert|obra_edificacio_simplificat)/);
  const tipo = tipoMatch ? tipoMatch[1] : null;
  
  // 2. Detectar categor√≠a
  if (nombreArchivo.includes('PLANTILLA_TAGS') || nombreArchivo.includes('plantilla_tags')) {
    return 'PLANTILLAS_TAGS';
  }
  
  if (nombreArchivo.includes('PLANTILLA') || nombreArchivo.includes('plantilla')) {
    return 'PLANTILLAS_BASE';
  }
  
  if (nombreArchivo.includes('generado') || nombreArchivo.includes('GENERADO')) {
    return `PLIEGOS_GENERADOS_${tipo.toUpperCase()}`;
  }
  
  // 3. An√°lisis de contenido para casos ambiguos
  if (contenido.includes('{{') && contenido.includes('}}')) {
    return 'PLANTILLAS_TAGS';
  }
  
  if (tieneErroresComunes(contenido)) {
    return 'ERRORES_COMUNES_PLIEGOS';
  }
  
  return 'CASOS_ESPECIALES_VALIDACION';
}
```

================================================================================
                        ESTRATEGIAS DE CONSULTA POR CONTEXTO
================================================================================

CONSULTAS SOBRE ESTRUCTURA:
```
Contexto preferido: PLANTILLAS_BASE
Ejemplo: "¬øCu√°les son los apartados obligatorios en obra civil obert?"
Estrategia: Buscar en plantillas base del tipo espec√≠fico
```

CONSULTAS SOBRE VARIABLES SAP:
```
Contexto preferido: PLANTILLAS_TAGS
Ejemplo: "¬øQu√© tags SAP se usan para el presupuesto?"
Estrategia: Analizar plantillas con tags del tipo relevante
```

CONSULTAS SOBRE IMPLEMENTACI√ìN:
```
Contexto preferido: PLIEGOS_GENERADOS_{TIPO}
Ejemplo: "¬øC√≥mo se presenta la informaci√≥n de lotes en la pr√°ctica?"
Estrategia: Buscar ejemplos reales en pliegos generados
```

CONSULTAS SOBRE ERRORES:
```
Contexto preferido: ERRORES_COMUNES_PLIEGOS
Ejemplo: "¬øCu√°les son los errores m√°s frecuentes en pliegos?"
Estrategia: Consultar base de conocimiento de errores
```

CONSULTAS COMPLEJAS:
```
Contextos m√∫ltiples: Combinaci√≥n seg√∫n necesidad
Ejemplo: "¬øC√≥mo validar que un pliego generado cumple la plantilla?"
Estrategia: Comparar PLANTILLAS_BASE con PLIEGOS_GENERADOS
```

================================================================================
                        INSTRUCCIONES PARA CONSULTAS INTELIGENTES
================================================================================

CUANDO RECIBAS UNA PREGUNTA SOBRE PLIEGOS:

1. IDENTIFICAR TIPO DE CONSULTA:
   - Estructural ‚Üí PLANTILLAS_BASE
   - Variables/Tags ‚Üí PLANTILLAS_TAGS  
   - Implementaci√≥n ‚Üí PLIEGOS_GENERADOS_{TIPO}
   - Errores ‚Üí ERRORES_COMUNES_PLIEGOS
   - Casos especiales ‚Üí CASOS_ESPECIALES_VALIDACION

2. DETERMINAR TIPO DE PLIEGO RELEVANTE:
   - ¬øSe refiere a obra civil u obra edificaci√≥n?
   - ¬øProcedimiento abierto o simplificado?
   - ¬øCon lotes o sin lotes?

3. SELECCIONAR CONTEXTO(S) APROPIADO(S):
   - Contexto principal para la consulta
   - Contextos secundarios si es necesario
   - Orden de prioridad para b√∫squeda

4. FORMULAR RESPUESTA COMPLETA:
   - Informaci√≥n espec√≠fica del contexto consultado
   - Ejemplos concretos cuando sea posible
   - Referencias cruzadas a otros contextos si es relevante

================================================================================
                        EJEMPLOS DE CONSULTAS Y RESPUESTAS
================================================================================

PREGUNTA: "¬øC√≥mo debe estructurarse el apartado de presupuesto?"

PROCESO:
1. Tipo consulta: Estructural
2. Contexto principal: PLANTILLAS_BASE
3. Contexto secundario: PLIEGOS_GENERADOS (para ejemplos)

RESPUESTA:
```
Seg√∫n las plantillas base, el apartado de presupuesto debe incluir:

üìã ESTRUCTURA EST√ÅNDAR (de PLANTILLAS_BASE):
- 2. PRESUPUESTO BASE DE LICITACI√ìN
- 2.1 Importe base
- 2.2 IVA aplicable  
- 2.3 Valor estimado del contrato

üí° IMPLEMENTACI√ìN PR√ÅCTICA (de PLIEGOS_GENERADOS):
En los pliegos generados observamos:
- Formato: "123.456,78 ‚Ç¨" (punto miles, coma decimales)
- IVA: "21% sobre base imponible"
- Presentaci√≥n en tabla cuando hay lotes
```

PREGUNTA: "¬øQu√© errores son m√°s comunes en la secci√≥n de lotes?"

PROCESO:
1. Tipo consulta: Errores
2. Contexto principal: ERRORES_COMUNES_PLIEGOS
3. Contexto secundario: PLIEGOS_GENERADOS (para contrastar)

RESPUESTA:
```
Seg√∫n el an√°lisis de errores comunes:

üî¥ ERRORES CR√çTICOS:
- Inconsistencia entre n√∫mero declarado y lotes presentes
- Numeraci√≥n no secuencial (Lote 1, Lote 3, falta Lote 2)
- Lotes sin presupuesto asignado

üü° ERRORES FRECUENTES:
- Formato incorrecto en importes de lotes
- Descripci√≥n insuficiente de cada lote
- Falta de criterios de adjudicaci√≥n por lote
```

================================================================================
                        MANTENIMIENTO DE CONTEXTOS
================================================================================

ACTUALIZACI√ìN PERI√ìDICA:

1. REVISAR RELEVANCIA:
   - ¬øLos documentos siguen siendo representativos?
   - ¬øHay nuevos patrones que documentar?
   - ¬øAlgunos ejemplos est√°n obsoletos?

2. BALANCEAR CONTENIDO:
   - Mantener proporci√≥n equilibrada entre tipos
   - Evitar sobrecarga de un contexto espec√≠fico
   - Asegurar cobertura de todos los casos

3. OPTIMIZAR B√öSQUEDAS:
   - Monitorear qu√© consultas son m√°s frecuentes
   - Ajustar contenido seg√∫n patrones de uso
   - Mejorar metadatos para mejor recuperaci√≥n

4. VALIDAR CALIDAD:
   - Verificar que ejemplos siguen buenas pr√°cticas
   - Actualizar casos de error seg√∫n nuevos hallazgos
   - Mantener coherencia en terminolog√≠a

================================================================================
                        INTEGRACI√ìN CON ENDPOINTS
================================================================================

ENDPOINT SUGERIDO: /api/rag/consulta-inteligente

```javascript
POST /api/rag/consulta-inteligente
{
  "pregunta": "¬øC√≥mo estructurar apartado presupuesto?",
  "tipo_pliego": "obra_civil_obert", // opcional
  "modalidad": "con_lotes", // opcional
  "contexto_preferido": "PLANTILLAS_BASE" // opcional
}

RESPUESTA:
{
  "respuesta": "...",
  "contextos_consultados": ["PLANTILLAS_BASE", "PLIEGOS_GENERADOS_OBRA_CIVIL_OBERT"],
  "ejemplos_referencia": [...],
  "documentos_fuente": [...]
}
```

================================================================================
                        M√âTRICAS DE EFECTIVIDAD
================================================================================

MEDIR REGULARMENTE:

üìä PRECISI√ìN DE RESPUESTAS:
- % consultas respondidas correctamente
- Tiempo promedio de respuesta
- Satisfacci√≥n del usuario con respuestas

üìà USO DE CONTEXTOS:
- Contextos m√°s consultados
- Patrones de consultas cruzadas
- Efectividad de asignaci√≥n autom√°tica

üéØ CALIDAD DE CONTENIDO:
- Documentos m√°s referenciados
- Casos que requieren actualizaci√≥n
- Gaps en cobertura de conocimiento

================================================================================
                                NOTAS IMPORTANTES
================================================================================

- Mantener contextos enfocados y espec√≠ficos
- Evitar duplicaci√≥n innecesaria entre contextos
- Priorizar calidad sobre cantidad de documentos
- Actualizar regularmente seg√∫n feedback de uso
- Documentar decisiones de clasificaci√≥n para consistencia
- Monitorear rendimiento y ajustar seg√∫n necesidades

================================================================================
                                    FIN
================================================================================
